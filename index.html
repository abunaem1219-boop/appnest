<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>User App</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { width: 100%; height: 100%; overflow: hidden; background: #fff; font-family: 'Segoe UI', sans-serif; }

        /* --- MAIN FRAME (FULL SCREEN) --- */
        #mainFrame {
            width: 100%; height: 100%; border: none; display: block;
            position: absolute; top: 0; left: 0; z-index: 1;
            /* লোডিং এর সময় ফ্রেমটি দেখা যাবে কিন্তু ব্লার ইফেক্টের নিচে থাকবে */
            opacity: 1; 
        }

        /* --- NEW CENTERED BLUR LOADER --- */
        #loaderScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5000;
            display: flex; align-items: center; justify-content: center;
            
            /* Background Blur Effect */
            background: rgba(255, 255, 255, 0.6); /* হালকা স্বচ্ছ সাদা */
            backdrop-filter: blur(8px); /* পেছনের কন্টেন্ট ব্লার করবে */
            -webkit-backdrop-filter: blur(8px);
            
            transition: opacity 0.4s ease; /* ফেইড আউট এনিমেশন */
        }

        /* Small Loading Spinner Animation */
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4e54c8; /* স্পিনারের রঙ */
            border-radius: 50%;
            animation: spin 0.8s linear infinite; /* ১ সেকেন্ডেরও কম সময়ে ঘুরবে */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- POPUP / NOTICE --- */
        .popup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 6000;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .popup-box {
            background: rgba(255, 255, 255, 0.95);
            width: 90%; max-width: 380px;
            border-radius: 20px; padding: 25px; position: relative;
            text-align: center; box-shadow: 0 15px 50px rgba(0,0,0,0.2);
            animation: popUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 85vh; overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.5);
        }
        @keyframes popUp { from{transform: scale(0.8); opacity:0;} to{transform: scale(1); opacity:1;} }
        
        .close-btn {
            position: absolute; top: 15px; right: 15px;
            width: 32px; height: 32px; background: #eee; color: #333;
            border-radius: 50%; border: none; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; transition: 0.2s;
        }
        .close-btn:hover { background: #ff4757; color: white; }

        .popup-title { color: #4e54c8; margin-bottom: 15px; font-size: 1.4rem; font-weight: 700; }
        .popup-msg { color: #555; font-size: 1rem; line-height: 1.5; margin-bottom: 25px; }

        /* --- ICONS INSIDE POPUP --- */
        .popup-icons-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
            border-top: 1px solid #eee; padding-top: 20px; margin-top: 10px;
        }
        .icon-link {
            text-decoration: none; color: #333;
            display: flex; flex-direction: column; align-items: center;
        }
        .icon-link img {
            width: 50px; height: 50px; border-radius: 12px;
            object-fit: cover; margin-bottom: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            background: #fff;
        }
        .icon-link:active img { transform: scale(0.9); }
        .icon-link span { font-size: 0.8rem; font-weight: 600; color: #666; }
        
        /* Skeleton for Popup Text Only */
        .skeleton {
            background: #e0e0e0;
            background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
            background-size: 200% 100%;
            border-radius: 8px;
            animation: shimmer 1.5s infinite;
        }
        .sk-text-line { width: 100%; height: 15px; margin-bottom: 10px; border-radius: 4px; }
        .sk-text-short { width: 60%; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    </style>
</head>
<body>

    <!-- NEW LOADER SCREEN (Centered Spinner with Blur) -->
    <div id="loaderScreen">
        <div class="spinner"></div>
    </div>

    <!-- MAIN HTML CONTENT -->
    <iframe id="mainFrame" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"></iframe>

    <!-- POPUP NOTICE -->
    <div class="popup-overlay" id="noticePopup">
        <div class="popup-box">
            <button class="close-btn" onclick="closePopup()">✕</button>
            <h3 class="popup-title" id="popTitle">Notice</h3>
            <div class="popup-msg" id="popMsg">
                <div class="skeleton sk-text-line"></div>
                <div class="skeleton sk-text-line sk-text-short"></div>
            </div>
            <div class="popup-icons-grid" id="popupIcons"></div>
        </div>
    </div>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCamY7KVHoMe2JYwpyI5ZppDK0a3ADIono",
            authDomain: "nstore-2dc39.firebaseapp.com",
            databaseURL: "https://nstore-2dc39-default-rtdb.firebaseio.com",
            projectId: "nstore-2dc39",
            storageBucket: "nstore-2dc39.firebasestorage.app",
            messagingSenderId: "908166095900",
            appId: "1:908166095900:web:a4493f45fee97a45c7abd9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. LOAD MAIN CONTENT
        db.ref('htmlContent/content').on('value', snap => {
            const frame = document.getElementById('mainFrame');
            const content = snap.val();

            if(content) {
                frame.srcdoc = content;
                
                // Content লোড হওয়ার পর লোডার সরিয়ে দিন
                frame.onload = function() {
                    fadeOutLoader();
                };
                
                // Backup timeout কমিয়ে ১ সেকেন্ডের নিচে আনা হয়েছে (800ms)
                setTimeout(fadeOutLoader, 800);
            }
        });

        function fadeOutLoader() {
            const loader = document.getElementById('loaderScreen');
            if(loader.style.display !== 'none') {
                loader.style.opacity = '0'; // Smooth fade out
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 400); // 0.4s transition এর সাথে মিল রেখে
            }
        }

        // 2. CHECK POPUP & LOAD ICONS
        window.onload = function() {
            checkPopup();
        };

        function checkPopup() {
            db.ref('popupSettings').once('value', snap => {
                const data = snap.val();
                if(!data || !data.enabled) return;

                document.getElementById('popTitle').innerText = data.title;
                document.getElementById('popMsg').innerHTML = data.message;
                
                loadIcons();

                const lastSeen = localStorage.getItem('lastPopupTime');
                const now = Date.now();
                let show = false;

                if(data.frequency === 'always') show = true;
                else if(data.frequency === 'once' && !lastSeen) show = true;
                else if(data.frequency === 'daily') {
                    if(!lastSeen || (now - parseInt(lastSeen) > 86400000)) show = true;
                }

                if(show) {
                    setTimeout(() => {
                        document.getElementById('noticePopup').style.display = 'flex';
                    }, 2000);
                    localStorage.setItem('lastPopupTime', now.toString());
                }
            });
        }

        function loadIcons() {
            db.ref('iconLinks').once('value', snap => {
                const container = document.getElementById('popupIcons');
                container.innerHTML = '';
                
                if(snap.exists()){
                    snap.forEach(child => {
                        const item = child.val();
                        const a = document.createElement('a');
                        a.className = 'icon-link';
                        a.href = item.url;
                        
                        a.innerHTML = `
                            <img src="${item.img}" onerror="this.src='https://via.placeholder.com/50'">
                            <span>${item.title}</span>
                        `;
                        container.appendChild(a);
                    });
                } else {
                    container.style.display = 'none';
                }
            });
        }

        function closePopup() {
            document.getElementById('noticePopup').style.display = 'none';
        }

    </script>
</body>
</html>